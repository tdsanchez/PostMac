<!DOCTYPE html>
<html>
<head>
	<title>{{.File.Name}} - Media Server</title>
	<style>
		* { margin: 0; padding: 0; box-sizing: border-box; }
		body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: #000; color: #fff; overflow: hidden; }
		.viewer { display: flex; flex-direction: column; height: 100vh; }

		/* Floating Header */
		.header { position: fixed; top: 0; left: 0; right: 0; background: rgba(0,0,0,0.95); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; z-index: 1000; }
		.header-left { display: flex; align-items: center; gap: 15px; }
		.breadcrumb { display: flex; align-items: center; gap: 8px; font-size: 14px; }
		.breadcrumb-item { color: #4DA3FF; text-decoration: none; font-weight: 500; transition: color 0.2s; }
		.breadcrumb-item:hover { color: #6BB5FF; text-decoration: underline; }
		.breadcrumb-item:focus { outline: 3px solid #4DA3FF; outline-offset: 2px; border-radius: 4px; }
		.breadcrumb-separator { color: #666; user-select: none; }
		.breadcrumb-current { color: #B3B3B3; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 300px; }
		.header-right { display: flex; align-items: center; gap: 15px; }
		.quicklook-btn { background: rgba(0,122,255,0.2); border: 1px solid #4DA3FF; color: #4DA3FF; padding: 6px 14px; border-radius: 6px; font-size: 13px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
		.quicklook-btn:hover { background: rgba(0,122,255,0.3); }
		.quicklook-btn:focus { outline: 3px solid #4DA3FF; outline-offset: 2px; }
		.counter { color: #B3B3B3; font-size: 14px; }
		.shutdown-button { background: #FF3B30; color: white; border: none; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 6px; transition: background 0.2s; box-shadow: 0 2px 4px rgba(255, 59, 48, 0.3); }
		.shutdown-button:hover { background: #FF2D21; }
		.power-icon { font-size: 14px; }

		/* Modal */
		.modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); z-index: 10000; align-items: center; justify-content: center; }
		.modal-overlay.show { display: flex; }
		.modal { background: #222; border-radius: 12px; padding: 30px; max-width: 400px; width: 90%; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5); border: 1px solid #444; }
		.modal-title { font-size: 20px; font-weight: 600; margin-bottom: 16px; color: #fff; }
		.modal-message { font-size: 16px; color: #B3B3B3; margin-bottom: 24px; line-height: 1.5; }
		.modal-buttons { display: flex; gap: 12px; justify-content: flex-end; }
		.modal-button { padding: 10px 20px; border: none; border-radius: 6px; font-size: 15px; font-weight: 500; cursor: pointer; transition: background 0.2s; }
		.modal-button.cancel { background: #444; color: #fff; }
		.modal-button.cancel:hover { background: #555; }
		.modal-button.confirm { background: #FF3B30; color: white; }
		.modal-button.confirm:hover { background: #FF2D21; }
		.media-container { flex: 1; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
		.media-container img, .media-container video { max-width: 100%; max-height: 100%; width: 100%; height: 100%; object-fit: contain; }
		.media-container iframe { width: 95%; height: 95%; border: none; background: white; }
		.media-container pre { max-width: 95%; max-height: 95%; overflow: auto; background: #1e1e1e; color: #d4d4d4; padding: 20px; border-radius: 8px; font-family: 'Monaco', 'Menlo', 'Consolas', monospace; font-size: 14px; line-height: 1.6; }
		.nav-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.1); border: none; color: white; font-size: 48px; padding: 20px 30px; cursor: pointer; transition: background 0.2s; backdrop-filter: blur(10px); z-index: 10; min-width: 88px; min-height: 88px; }
		.nav-btn:hover { background: rgba(255,255,255,0.2); }
		.nav-btn:focus { outline: 3px solid #4DA3FF; outline-offset: 2px; }
		.nav-btn.prev { left: 20px; }
		.nav-btn.next { right: 20px; }

		/* Text file viewing mode - arrows outside content area */
		body.viewing-text .nav-btn { position: fixed; background: rgba(0,0,0,0.8); border: 1px solid rgba(255,255,255,0.3); font-size: 36px; padding: 30px 12px; width: 50px; min-width: 50px; }
		body.viewing-text .nav-btn.prev { left: 0; }
		body.viewing-text .nav-btn.next { right: 0; }
		body.viewing-text .media-container pre { max-width: 90%; padding: 30px 80px; margin: 0 auto; }
		.info-panel { background: rgba(0,0,0,0.9); padding: 15px 20px; border-top: 1px solid #333; }
		.info-row { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; font-size: 14px; margin-bottom: 15px; }
		.info-item { color: #B3B3B3; white-space: nowrap; }
		.filename-inline { color: #E0E0E0; font-weight: 500; }
		.tags-inline { display: inline-flex; flex-wrap: wrap; gap: 6px; align-items: center; }
		.shortcuts { color: #999; font-size: 13px; }
		.tag { display: inline-block; padding: 4px 6px; background: #007AFF; color: white; border-radius: 6px; font-size: 12px; text-decoration: none; transition: background 0.2s; cursor: pointer; min-height: 20px; line-height: 10px; }
		.tag:hover { background: #0051D5; }
		.tag:focus { outline: 2px solid #fff; outline-offset: 2px; box-shadow: 0 0 0 4px #007AFF; }
		.tag.current { background: #34C759; }
		.context-menu { position: fixed; background: rgba(30,30,30,0.98); border: 1px solid #777; border-radius: 8px; padding: 4px 0; display: none; z-index: 2000; backdrop-filter: blur(10px); box-shadow: 0 4px 12px rgba(0,0,0,0.5); min-width: 200px; }
		.context-menu-item { padding: 12px 18px; cursor: pointer; font-size: 15px; display: flex; align-items: center; gap: 10px; min-height: 44px; }
		.context-menu-item:hover { background: rgba(0,122,255,0.3); }
		.tag-input-container { display: none; margin-top: 10px; }
		.tag-input-container.active { display: block; }
		.tag-input { background: rgba(255,255,255,0.1); border: 1px solid #777; color: white; padding: 10px 14px; border-radius: 6px; font-size: 16px; width: 300px; }
		.tag-input:focus { outline: none; border-color: #4DA3FF; box-shadow: 0 0 0 3px rgba(77,163,255,0.3); }
		.autocomplete { background: rgba(0,0,0,0.95); border: 1px solid #777; border-radius: 6px; margin-top: 5px; max-height: 150px; overflow-y: auto; }
		.autocomplete-item { padding: 10px 14px; cursor: pointer; font-size: 15px; min-height: 44px; display: flex; align-items: center; }
		.autocomplete-item:hover { background: rgba(255,255,255,0.1); }
		.autocomplete-item.selected { background: rgba(0,122,255,0.3); }
		.notification { position: fixed; top: 70px; right: 20px; background: rgba(52,199,89,0.9); padding: 14px 22px; border-radius: 8px; font-size: 16px; display: none; z-index: 1001; }
		.notification.show { display: block; animation: slideIn 0.3s ease; }
		.slideshow-indicator { position: fixed; top: 70px; left: 20px; background: rgba(255,149,0,0.9); padding: 14px 22px; border-radius: 8px; font-size: 16px; display: none; z-index: 1001; color: white; font-weight: 600; }
		.slideshow-indicator.active { display: block; }
		@keyframes slideIn { from { transform: translateX(400px); } to { transform: translateX(0); } }
		.comment-container { margin-top: 15px; padding-top: 15px; border-top: 1px solid #333; }
		.comment-title { font-size: 16px; font-weight: 600; margin-bottom: 10px; color: #B3B3B3; }
		.comment-display { color: #E0E0E0; font-size: 15px; cursor: pointer; white-space: pre-wrap; word-break: break-word; line-height: 1.6; padding: 8px 10px; background: rgba(255,255,255,0.05); border-radius: 6px; min-height: 40px; }
		.comment-display:hover { background: rgba(255,255,255,0.08); }
		.comment-display.empty { color: #999; font-style: italic; }
		.comment-display.empty:before { content: "Click to add comment..."; }
		.comment-edit { width: 100%; min-height: 80px; background: rgba(255,255,255,0.1); color: #fff; border: 2px solid #4DA3FF; border-radius: 6px; padding: 10px; font-size: 15px; font-family: inherit; resize: vertical; box-sizing: border-box; display: none; }
		.comment-edit:focus { outline: none; border-color: #6BB5FF; box-shadow: 0 0 0 3px rgba(77,163,255,0.3); }
		.comment-saving { opacity: 0.6; pointer-events: none; }
		.os-path-container { margin-top: 10px; padding-top: 10px; border-top: 1px solid #333; }
		.os-path-label { color: #999; font-size: 12px; margin-bottom: 4px; display: block; text-transform: uppercase; letter-spacing: 0.5px; }
		.os-path-display { color: #B3B3B3; font-size: 13px; font-family: 'Monaco', 'Menlo', 'Consolas', monospace; padding: 6px 10px; background: rgba(255,255,255,0.05); border-radius: 6px; word-break: break-all; }
	</style>
</head>
<body{{if isTextFile .File.Name}} class="viewing-text"{{end}}>
	<div class="viewer">
		<div class="header">
			<div class="header-left">
				<nav class="breadcrumb">
					<a href="/" class="breadcrumb-item">üè†</a>
					<span class="breadcrumb-separator">‚Ä∫</span>
					{{$segments := parseFolderBreadcrumbs .Tag}}
					{{range $i, $segment := $segments}}
						{{if gt $i 0}}<span class="breadcrumb-separator">‚Ä∫</span>{{end}}
						<a href="{{$segment.URL}}" class="breadcrumb-item">{{$segment.Label}}</a>
					{{end}}
					<span class="breadcrumb-separator">‚Ä∫</span>
					<span class="breadcrumb-current">{{.File.Name}}</span>
				</nav>
			</div>
			<div class="header-right">
				<button class="quicklook-btn" onclick="quickLookPreview()">
					<span>üëÅ</span> QuickLook
				</button>
				<div class="counter">{{.Index}} / {{.Total}}</div>
				<button class="shutdown-button" onclick="showShutdownModal()">
					<span class="power-icon">‚èª</span>
				</button>
			</div>
		</div>
		<div class="media-container">
			{{if or (hasSuffix .File.Name ".jpg") (hasSuffix .File.Name ".jpeg") (hasSuffix .File.Name ".png") (hasSuffix .File.Name ".gif") (hasSuffix .File.Name ".webp")}}
				<img src="/file/{{.File.RelPath}}" alt="{{.File.Name}}">
			{{else if or (hasSuffix .File.Name ".mp4") (hasSuffix .File.Name ".mov") (hasSuffix .File.Name ".m4v")}}
				<video src="/file/{{.File.RelPath}}" controls autoplay muted></video>
			{{else if hasSuffix .File.Name ".pdf"}}
				<iframe src="/file/{{.File.RelPath}}" type="application/pdf"></iframe>
			{{else if isTextFile .File.Name}}
				<pre id="text-content">Loading...</pre>
			{{else if isHTMLFile .File.Name}}
				<iframe src="/file/{{.File.RelPath}}"></iframe>
			{{else if isConvertibleFile .File.Name}}
				<iframe id="converted-content" src="/api/convert/{{.File.RelPath}}"></iframe>
			{{else}}
				<pre>Unsupported file type</pre>
			{{end}}
			<button class="nav-btn prev" onclick="navigatePrev()">‚Üê</button>
			<button class="nav-btn next" onclick="navigateNext()">‚Üí</button>
		</div>
		<div class="info-panel">
			<div class="info-row">
				<span class="info-item">[<span class="filename-inline">{{.File.Name}}</span>]</span>
				<span class="info-item">[<span class="tags-inline" id="tags-container">{{range $i, $tag := .File.Tags}}{{if $i}} {{end}}<a href="/tag/{{urlEncode $tag}}" class="tag{{if eq $tag $.Tag}} current{{end}}" data-tag="{{$tag}}">{{$tag}}</a>{{end}}</span>]</span>
				<span class="info-item" id="metadata-inline">[Loading...]</span>
				<span class="info-item">[<span class="shortcuts">‚Üê ‚Üí navigate | S slideshow | +/- timing | R random | T tags | C comment | Q QuickLook | X delete | L love | 1-5 stars</span>]</span>
			</div>
			<div class="tag-input-container" id="tag-input-container">
				<input type="text" class="tag-input" id="tag-input" placeholder="Type tag and press Enter (ESC to close)...">
				<div class="autocomplete" id="autocomplete"></div>
			</div>
			<div class="comment-container">
				<div class="comment-title">üí¨ Comment</div>
				<div class="comment-display{{if not .File.Comment}} empty{{end}}" id="comment-display">{{.File.Comment}}</div>
				<textarea class="comment-edit" id="comment-edit"></textarea>
			</div>
			<div class="os-path-container">
				<div class="os-path-display">Path: {{.File.Path}}</div>
			</div>
		</div>
	</div>
	<div class="notification" id="notification"></div>
	<div class="slideshow-indicator" id="slideshow-indicator">‚ñ∂Ô∏è SLIDESHOW: 3s</div>
	<div class="context-menu" id="context-menu">
		<div class="context-menu-item" id="menu-goto">
			<span>üîó</span> Go to Tag Gallery
		</div>
		<div class="context-menu-item" id="menu-delete">
			<span>üóëÔ∏è</span> Delete Tag
		</div>
	</div>

	<!-- Shutdown Confirmation Modal -->
	<div class="modal-overlay" id="shutdownModal">
		<div class="modal">
			<div class="modal-title">‚èª Shutdown Server</div>
			<div class="modal-message">Do you really want to quit this media server?</div>
			<div class="modal-buttons">
				<button class="modal-button cancel" onclick="hideShutdownModal()">Cancel</button>
				<button class="modal-button confirm" onclick="confirmShutdown()">Shutdown</button>
			</div>
		</div>
	</div>

	<!-- Delete File Confirmation Modal -->
	<div class="modal-overlay" id="deleteModal">
		<div class="modal">
			<div class="modal-title">üóëÔ∏è Delete File</div>
			<div class="modal-message">Move this file to Trash? This will remove it from the library.</div>
			<div class="modal-buttons">
				<button class="modal-button cancel" onclick="hideDeleteModal()">Cancel</button>
				<button class="modal-button confirm" onclick="confirmDelete()">Move to Trash</button>
			</div>
		</div>
	</div>

	<script>
{{.JavaScript}}
	</script>
</body>
</html>